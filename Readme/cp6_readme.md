WCF-—Å–µ—Ä–≤–∏—Å —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (WS-Security Message Mode) –∏ –∑–∞—â–∏—â—ë–Ω–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º –ø–æ —Ä–æ–ª—è–º

–ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ —Ä–∞–º–∫–∞—Ö –ö–¢6.
–¶–µ–ª—å ‚Äî —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞—â–∏—â—ë–Ω–Ω—ã–π WCF-—Å–µ—Ä–≤–∏—Å –∏ WPF-–∫–ª–∏–µ–Ω—Ç, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â–∏–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –º–µ—Ç–æ–¥–∞–º.

üìå 1. –¶–µ–ª—å —Ä–∞–±–æ—Ç—ã

–°–æ–∑–¥–∞—Ç—å WCF-—Å–ª—É–∂–±—É, –∏—Å–ø–æ–ª—å–∑—É—é—â—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (UserName/Password) –≤ —Ä–µ–∂–∏–º–µ WS-Security (Message Security).
–°–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω:

–ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ –æ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤;

–æ–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º –º–µ—Ç–æ–¥–∞–º —Ç–æ–ª—å–∫–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º/—Ä–æ–ª—è–º;

–ø–æ–∑–≤–æ–ª—è—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é WPF –≤—ã–∑—ã–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –æ—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–∞.

üìå 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è
–°–æ—Å—Ç–∞–≤ –ø—Ä–æ–µ–∫—Ç–∞

WcfServiceLibrary1
–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ WCF-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤.

WcfServiceHost
–ö–æ–Ω—Å–æ–ª—å–Ω—ã–π self-host WCF (ServiceHost).
–•–æ—Å—Ç–∏—Ç 4 —Å–µ—Ä–≤–∏—Å–∞:

Service1 (–ö–¢2)

EmployeeService (–ö–¢4)

OrderService (–ö–¢5)

SecurityService (–ö–¢6)

SecurityClient (WPF)
–ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ WPF, –≤—ã–∑—ã–≤–∞—é—â–µ–µ –º–µ—Ç–æ–¥—ã SecurityService.

üìå 3. SecurityService ‚Äî —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å:

[ServiceContract]
public interface ISecurityService
{
    [OperationContract]
    string GetPublicInfo();

    [OperationContract]
    string GetManagerSecret();
}


–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:

GetPublicInfo() ‚Äî –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.

GetManagerSecret() ‚Äî –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é admin (—Ä–æ–ª—å ¬´Manager¬ª –ø–æ —Å–º—ã—Å–ª—É).

var username = ServiceSecurityContext.Current.PrimaryIdentity.Name;

if (username != "admin")
    throw new FaultException("Access denied: —Ç–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ.");

üìå 4. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (UserName/Password)

–í self-host'–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π –≤–∞–ª–∏–¥–∞—Ç–æ—Ä:

public class SimpleUserValidator : UserNamePasswordValidator
{
    public override void Validate(string username, string password)
    {
        if (username == "admin" && password == "123") return;
        if (username == "user"  && password == "123") return;

        throw new SecurityTokenException("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å");
    }
}

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:
–õ–æ–≥–∏–Ω	–ü–∞—Ä–æ–ª—å	–î–æ—Å—Ç—É–ø –∫ GetManagerSecret
admin	123	‚úî –µ—Å—Ç—å
user	123	‚ùå –Ω–µ—Ç
üìå 5. –°–µ—Ä–≤–∏—Å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (WS-Security Message)

SecurityService –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:

wsHttpBinding

security mode="Message"

<message clientCredentialType="UserName"/>

—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç X.509 –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ WS-Security —Å–æ–æ–±—â–µ–Ω–∏–π

–ü—Ä–∏–º–µ—Ä binding:
<wsHttpBinding>
  <binding name="UsernameBinding">
    <security mode="Message">
      <message clientCredentialType="UserName" />
    </security>
  </binding>
</wsHttpBinding>

üìå 6. –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–ª—É–∂–±—ã

–î–ª—è WS-Security —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç.
–°–æ–∑–¥–∞–Ω —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç:

Subject: CN=localhost
Thumbprint: 31E4AE7B6BC65B87603202A64FC6BE22164C0B1C


–í App.config —Ö–æ—Å—Ç–∞:

<serviceCertificate
    findValue="31E4AE7B6BC65B87603202A64FC6BE22164C0B1C"
    x509FindType="FindByThumbprint"
    storeLocation="CurrentUser"
    storeName="My" />


–ö–ª–∏–µ–Ω—Ç –¥–æ–≤–µ—Ä—è–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É —á–µ—Ä–µ–∑ PeerTrust, –ø–æ—ç—Ç–æ–º—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –±—ã–ª –ø–æ–º–µ—â—ë–Ω –≤:

Certificates ‚Üí CurrentUser ‚Üí Trusted People

üìå 7. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ WPF-–∫–ª–∏–µ–Ω—Ç–∞

–í –∫–ª–∏–µ–Ω—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Service Reference –∫:

http://localhost:8740/SecurityService/mex


–ù–∞—Å—Ç—Ä–æ–µ–Ω endpoint:

<endpoint address="http://localhost:8740/SecurityService/"
          binding="wsHttpBinding"
          bindingConfiguration="WSHttpBinding_ISecurityService"
          contract="SecurityRef.ISecurityService"
          behaviorConfiguration="SecurityClientBehavior" />


–ö–ª–∏–µ–Ω—Ç –¥–æ–≤–µ—Ä—è–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É:

<authentication certificateValidationMode="PeerTrust"
                revocationMode="NoCheck" />

üìå 8. –õ–æ–≥–∏–∫–∞ WPF-–∫–ª–∏–µ–Ω—Ç–∞
var client = new SecurityServiceClient();
client.ClientCredentials.UserName.UserName = username;
client.ClientCredentials.UserName.Password = password;

try
{
    var info = client.GetPublicInfo();
    Output("Public: " + info);

    var secret = client.GetManagerSecret();
    Output("Manager: " + secret);
}
catch (FaultException ex)
{
    Output("Fault: " + ex.Message);
}

üìå 9. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã
‚úî user / 123
Public: –≠—Ç–æ –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...
Fault: Access denied: —Ç–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ.

‚úî admin / 123
Public: –≠—Ç–æ –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...
Manager: –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞: $$$

üìå 10. –ß—Ç–æ –ø–æ–∫–∞–∑–∞–Ω–æ –≤ –ö–¢6

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∑–∞—â–∏—â—ë–Ω–Ω–∞—è WCF-—Å–ª—É–∂–±–∞.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (UserName).

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω WS-Security Message Mode.

–ù–∞—Å—Ç—Ä–æ–µ–Ω –∫–∞—Å—Ç–æ–º–Ω—ã–π –≤–∞–ª–∏–¥–∞—Ç–æ—Ä –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å.

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–º–µ—Ç–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é).

–ö–ª–∏–µ–Ω—Ç WPF –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:

–ø–µ—Ä–µ–¥–∞—ë—Ç –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å;

–ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ;

–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç SOAP Fault;

–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–∞–∑–ª–∏—á–∏—è –≤ –ø—Ä–∞–≤–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

üìå 11. –í—ã–≤–æ–¥

–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ 6 –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é:

‚úî —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –∑–∞—â–∏—â—ë–Ω–Ω—ã–π WCF-—Å–µ—Ä–≤–∏—Å
‚úî —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è UserName/Password
‚úî —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ —Ä–æ–ª—è–º
‚úî —Å–æ–∑–¥–∞–Ω WPF-–∫–ª–∏–µ–Ω—Ç
‚úî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã WS-Security, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, binding‚Äô–∏ –∏ behaviors

–ü—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∑–∞—â–∏—â—ë–Ω–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è WCF-—Å–ª—É–∂–±—ã –∏ –∫–ª–∏–µ–Ω—Ç–∞.